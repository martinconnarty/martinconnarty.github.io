<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTPS Subnet Image Timing Checker</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }
        input, textarea { width: 200px; padding: 8px; margin: 10px 5px; }
        textarea { width: 300px; height: 60px; }
        input#concurrency { width: 80px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 15px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
        th { background: #f1f1f1; }
        .progress { margin: 20px 0; font-weight: bold; }
        .fast-hits { background: #d4edda; border-left-color: #28a745; }
    </style>
</head>
<body>
    <h1>HTTPS Subnet Image Timing Checker</h1>
    <p>Enter subnet (e.g., 192.168.1), comma-separated ports, and concurrency. Shows ONLY IPs/ports responding &lt;500ms.</p>
    
    <input type="text" id="subnet" placeholder="192.168.1" value="192.168.1">
    <textarea id="ports" placeholder="443,8443,8080">443</textarea>
    <input type="number" id="concurrency" placeholder="16" value="16" min="1" max="64">
    <button onclick="runTests()">Scan Subnet</button>
    
    <div id="results"></div>

    <script>
        const TIMEOUT = 2000; // 2 seconds
        const FAST_THRESHOLD = 500; // 0.5 seconds

        async function runTests() {
            const subnet = document.getElementById('subnet').value.trim();
            const portsText = document.getElementById('ports').value.trim();
            const concurrency = parseInt(document.getElementById('concurrency').value) || 16;
            const ports = portsText.split(',').map(p => p.trim()).filter(p => p);
            const resultsDiv = document.getElementById('results');
            
            if (!subnet || ports.length === 0) {
                resultsDiv.innerHTML = '<div class="error">Please enter subnet and at least one port.</div>';
                return;
            }

            // Generate IP range from subnet (e.g., 192.168.1 -> 192.168.1.1-254)
            const ips = generateIPs(subnet);
            resultsDiv.innerHTML = `<div class="progress">Scanning ${ips.length} IPs Ã— ${ports.length} ports (${ips.length * ports.length} total tests) at ${concurrency} concurrent...</div>`;

            // Run tests in batches
            const fastHits = [];
            for (let i = 0; i < ips.length; i += concurrency) {
                const batch = ips.slice(i, i + concurrency);
                const batchTests = batch.flatMap(ip => 
                    ports.map(port => testImage(ip, port))
                );
                const batchResults = await Promise.allSettled(batchTests);
                
                // Filter fast successes
                batchResults.forEach(result => {
                    if (result.status === 'fulfilled' && result.value.success && result.value.time < FAST_THRESHOLD) {
                        fastHits.push(result.value);
                    }
                });
                
                updateProgress(resultsDiv, i + batch.length, ips.length, fastHits.length);
            }

            displayResults(subnet, fastHits);
        }

        function generateIPs(subnet) {
            const parts = subnet.split('.');
            if (parts.length !== 3) return [];
            const base = parts.join('.');
            const ips = [];
            for (let i = 1; i <= 254; i++) {
                ips.push(`${base}.${i}`);
            }
            return ips;
        }

        async function testImage(host, port) {
            return new Promise((resolve) => {
                const start = performance.now();
                const target = `https://${host}:${port}/favicon.ico?${Date.now()}`;
                const img = new Image();
                
                img.onload = () => {
                    const end = performance.now();
                    resolve({ 
                        host, port, 
                        time: end - start, 
                        success: true,
                        target 
                    });
                };
                
                img.onerror = () => {
                    const end = performance.now();
                    resolve({ 
                        host, port, 
                        time: end - start, 
                        success: false,
                        target 
                    });
                };
                
                img.src = target;
                
                setTimeout(() => {
                    if (!img.complete) {
                        const end = performance.now();
                        resolve({ 
                            host, port, 
                            time: end - start, 
                            success: false,
                            target,
                            error: 'Timeout'
                        });
                    }
                }, TIMEOUT);
            });
        }

        function updateProgress(div, completed, total, fastHits) {
            div.innerHTML = `<div class="progress">
                Completed ${completed}/${total} IPs (${Math.round(completed/total*100)}%) | 
                ${fastHits} fast hits found (&lt;${FAST_THRESHOLD}ms)
            </div>`;
        }

        function displayResults(subnet, fastHits) {
            const resultsDiv = document.getElementById('results');
            if (fastHits.length === 0) {
                resultsDiv.innerHTML = `<div class="error">
                    <h3>No fast responders found</h3>
                    <p>No IP/port combinations responded in under ${FAST_THRESHOLD}ms.</p>
                </div>`;
                return;
            }

            // Group by IP
            const byIP = fastHits.reduce((acc, hit) => {
                if (!acc[hit.host]) acc[hit.host] = [];
                acc[hit.host].push(hit);
                return acc;
            }, {});

            let html = `<h3>Fast Responders (&lt;${FAST_THRESHOLD}ms) in ${subnet}.0/24</h3>
                <p>Found ${fastHits.length} fast endpoints across ${Object.keys(byIP).length} IPs</p>
                <table>
                    <tr><th>IP</th><th>Port</th><th>Time</th><th>Target</th></tr>`;

            Object.entries(byIP).sort(([a],[b]) => a.localeCompare(b)).forEach(([ip, ports]) => {
                ports.sort((a,b) => a.time - b.time).forEach(hit => {
                    html += `<tr class="fast-hits">
                        <td><strong>${hit.host}</strong></td>
                        <td>${hit.port}</td>
                        <td>${hit.time.toFixed(0)}ms</td>
                        <td>${hit.target}</td>
                    </tr>`;
                });
            });

            html += '</table>';
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
