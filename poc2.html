<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTPS Subnet Image Timing Checker</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        input, textarea, select { padding: 8px; margin: 5px; }
        input[type="text"] { width: 200px; }
        textarea { width: 300px; height: 60px; }
        select { width: 100px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .result { margin: 15px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9em; }
        th, td { padding: 6px; text-align: left; border: 1px solid #ddd; }
        th { background: #f1f1f1; }
        .progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #007bff; width: 0%; transition: width 0.3s; }
        .stats { display: flex; gap: 20px; margin: 10px 0; }
        .stat { background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <h1>HTTPS Subnet Image Timing Checker</h1>
    <p>Enter subnet (e.g., 192.168.1.0/24), ports (comma-separated), and max concurrent tests (16 default).</p>
    
    <input type="text" id="subnet" placeholder="192.168.1.0/24" value="192.168.1.0/24">
    <textarea id="ports" placeholder="443,8443">443</textarea>
    <select id="concurrency">
        <option value="8">8 concurrent</option>
        <option value="16" selected>16 concurrent</option>
        <option value="32">32 concurrent</option>
    </select>
    <button onclick="runTests()">Scan Subnet</button>
    
    <div id="progress" style="display:none;">
        <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
        <div id="progressText">0/0 (0%)</div>
    </div>
    
    <div id="stats" class="stats" style="display:none;"></div>
    <div id="results"></div>

    <script>
        const TIMEOUT = 2000;
        let allResults = [];

        function parseSubnet(subnet) {
            const [network, bits] = subnet.split('/');
            const [a, b, c, d] = network.split('.').map(Number);
            const mask = ~((1 << (32 - bits)) - 1);
            const start = (a << 24 | b << 16 | c << 8 | d) & mask;
            const end = start | (~mask & 0xFFFFFFFF);
            return { start, end };
        }

        function ipToString(num) {
            return [
                (num >> 24) & 255,
                (num >> 16) & 255,
                (num >> 8) & 255,
                num & 255
            ].join('.');
        }

        function generateIPs(start, end) {
            const ips = [];
            for (let i = start; i <= end; i++) {
                if ((i & 0xFF) !== 0 && (i & 0xFF) !== 255) { // Skip .0 and .255
                    ips.push(ipToString(i));
                }
            }
            return ips;
        }

        async function runTests() {
            const subnet = document.getElementById('subnet').value.trim();
            const portsText = document.getElementById('ports').value.trim();
            const concurrency = parseInt(document.getElementById('concurrency').value);
            const ports = portsText.split(',').map(p => p.trim()).filter(p => p);

            if (!subnet || ports.length === 0) {
                document.getElementById('results').innerHTML = '<div class="error">Enter subnet and ports.</div>';
                return;
            }

            const { start, end } = parseSubnet(subnet);
            const ips = generateIPs(start, end);
            allResults = [];
            
            document.getElementById('progress').style.display = 'block';
            document.getElementById('results').innerHTML = `<h3>Scanning ${ips.length} IPs x ${ports.length} ports = ${ips.length * ports.length} tests (16 concurrent)...`;
            document.getElementById('stats').style.display = 'none';

            const semaphore = createSemaphore(concurrency);
            const promises = [];

            for (const ip of ips) {
                for (const port of ports) {
                    promises.push(semaphore.run(() => testImage(ip, port)));
                }
            }

            await Promise.all(promises);
            displayResults(ips.length, ports.length);
        }

        function createSemaphore(maxConcurrent) {
            let active = 0;
            const queue = [];
            return {
                async run(task) {
                    return new Promise((resolve) => {
                        queue.push(() => {
                            active++;
                            updateProgress();
                            task().finally(() => {
                                active--;
                                updateProgress();
                                const next = queue.shift();
                                if (next) next();
                            }).then(resolve);
                        });
                        if (active < maxConcurrent) {
                            const next = queue.shift();
                            if (next) next();
                        }
                    });
                }
            };
        }

        function updateProgress() {
            const total = allResults.length;
            const percent = (total / (document.getElementById('progressText').dataset.total || 1)) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${total}/${document.getElementById('progressText').dataset.total || 0} (${percent.toFixed(0)}%)`;
        }

        async function testImage(host, port) {
            return new Promise((resolve) => {
                const start = performance.now();
                const target = `https://${host}:${port}/favicon.ico?${Date.now()}`;
                const img = new Image();
                
                img.onload = () => {
                    const end = performance.now();
                    allResults.push({ host, port, time: end - start, success: true, target });
                    resolve();
                };
                
                img.onerror = () => {
                    const end = performance.now();
                    allResults.push({ host, port, time: end - start, success: false, target, error: 'Failed' });
                    resolve();
                };
                
                img.src = target;
                
                setTimeout(() => {
                    if (!img.complete) {
                        const end = performance.now();
                        allResults.push({ host, port, time: end - start, success: false, target, error: 'Timeout' });
                        resolve();
                    }
                }, TIMEOUT);
            });
        }

        function displayResults(ipCount, portCount) {
            document.getElementById('progress').style.display = 'none';
            
            const up = allResults.filter(r => r.success);
            const byIP = {};
            allResults.forEach(r => {
                if (!byIP[r.host]) byIP[r.host] = { up: 0, total: 0 };
                byIP[r.host].total++;
                if (r.success) byIP[r.host].up++;
            });
            
            const liveIPs = Object.entries(byIP)
                .filter(([_, stats]) => stats.up > 0)
                .sort((a, b) => b[1].up - a[1].up);

            let html = `
                <div class="stats">
                    <div class="stat success">${up.length}/${allResults.length} tests passed</div>
                    <div class="stat">${liveIPs.length}/${ipCount} IPs responding</div>
                    <div class="stat">${up.length > 0 ? `${(up.reduce((s, r) => s + r.time, 0) / up.length).toFixed(0)}ms avg` : 'N/A'}</div>
                </div>
                <h3>Live IPs (${liveIPs.length})</h3>
                <table>
                    <tr><th>IP</th><th>Ports Up</th><th>Fastest (ms)</th></tr>`;

            liveIPs.slice(0, 50).forEach(([ip, stats]) => {
                const fastest = allResults.filter(r => r.host === ip && r.success)
                    .reduce((fast, r) => r.time < fast ? r.time : fast, Infinity);
                html += `<tr><td>${ip}</td><td>${stats.up}/${stats.total}</td><td>${fastest.toFixed(0)}</td></tr>`;
            });

            html += '</table>';
            if (liveIPs.length > 50) {
                html += `<p>... and ${liveIPs.length - 50} more</p>`;
            }

            document.getElementById('results').innerHTML = html;
            document.getElementById('stats').innerHTML = `
                <div class="stat success">${up.length}/${allResults.length} tests passed</div>
                <div class="stat">${liveIPs.length}/${ipCount} IPs responding</div>
                <div class="stat">${up.length > 0 ? `${(up.reduce((s, r) => s + r.time, 0) / up.length).toFixed(0)}ms avg` : 'N/A'}</div>`;
            document.getElementById('stats').style.display = 'flex';
        }
    </script>
</body>
</html>
