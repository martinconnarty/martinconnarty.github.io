<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTPS Subnet Image Timing Checker</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        input, textarea, select { padding: 8px; margin: 5px; }
        input[type="text"] { width: 200px; }
        textarea { width: 300px; height: 60px; }
        select { width: 100px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .result { margin: 15px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .live-host { background: #d4edda; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #28a745; }
        .live-link { color: #007bff; text-decoration: none; font-weight: bold; font-size: 1.1em; }
        .live-link:hover { text-decoration: underline; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9em; }
        th, td { padding: 6px; text-align: left; border: 1px solid #ddd; }
        th { background: #f1f1f1; }
        .progress { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #007bff; width: 0%; transition: width 0.3s; }
        .stats { display: flex; gap: 20px; margin: 10px 0; }
        .stat { background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center; }
        #liveHosts { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>HTTPS Subnet Image Timing Checker</h1>
    <p>Enter subnet (e.g., 192.168.1.0/24), ports. Fast hosts (<500ms) appear live as clickable links instantly.</p>
    
    <input type="text" id="subnet" placeholder="192.168.1.0/24" value="192.168.1.0/24">
    <textarea id="ports" placeholder="443,8443,80">443</textarea>
    <select id="concurrency">
        <option value="8">8 concurrent</option>
        <option value="16" selected>16 concurrent</option>
        <option value="32">32 concurrent</option>
    </select>
    <button onclick="runTests()">Scan Subnet</button>
    
    <div id="progress" style="display:none;">
        <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
        <div id="progressText">0/0 (0%)</div>
    </div>
    
    <div id="stats" class="stats" style="display:none;"></div>
    
    <div id="liveHosts">
        <h3>ðŸ”¥ Live Hosts (<500ms) <span id="liveCount">0</span></h3>
        <div id="liveList"></div>
    </div>
    
    <div id="results"></div>

    <script>
        const TIMEOUT = 2000;
        const FAST_THRESHOLD = 500; // 0.5 seconds
        let allResults = [];
        let liveHosts = new Set();

        function parseSubnet(subnet) {
            const [network, bits] = subnet.split('/');
            const [a, b, c, d] = network.split('.').map(Number);
            const mask = ~((1 << (32 - bits)) - 1);
            const start = (a << 24 | b << 16 | c << 8 | d) & mask;
            const end = start | (~mask & 0xFFFFFFFF);
            return { start, end };
        }

        function ipToString(num) {
            return [
                (num >> 24) & 255,
                (num >> 16) & 255,
                (num >> 8) & 255,
                num & 255
            ].join('.');
        }

        function generateIPs(start, end) {
            const ips = [];
            for (let i = start; i <= end; i++) {
                if ((i & 0xFF) !== 0 && (i & 0xFF) !== 255) {
                    ips.push(ipToString(i));
                }
            }
            return ips;
        }

        function getProtocol(port) {
            return parseInt(port) === 80 ? 'http' : 'https';
        }

        async function runTests() {
            const subnet = document.getElementById('subnet').value.trim();
            const portsText = document.getElementById('ports').value.trim();
            const concurrency = parseInt(document.getElementById('concurrency').value);
            const ports = portsText.split(',').map(p => p.trim()).filter(p => p);

            if (!subnet || ports.length === 0) {
                document.getElementById('results').innerHTML = '<div class="error">Enter subnet and ports.</div>';
                return;
            }

            const { start, end } = parseSubnet(subnet);
            const ips = generateIPs(start, end);
            allResults = [];
            liveHosts.clear();
            
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progressText').dataset.total = ips.length * ports.length;
            document.getElementById('liveList').innerHTML = '';
            document.getElementById('liveCount').textContent = '0';
            document.getElementById('results').innerHTML = `<h3>Scanning ${ips.length} IPs x ${ports.length} ports...`;
            document.getElementById('stats').style.display = 'none';

            const semaphore = createSemaphore(concurrency);
            const promises = [];

            for (const ip of ips) {
                for (const port of ports) {
                    promises.push(semaphore.run(() => testImage(ip, port)));
                }
            }

            await Promise.all(promises);
            displayFinalResults(ips.length, ports.length);
        }

        function createSemaphore(maxConcurrent) {
            let active = 0;
            const queue = [];
            return {
                async run(task) {
                    return new Promise((resolve) => {
                        queue.push(() => {
                            active++;
                            updateProgress();
                            task().finally(() => {
                                active--;
                                updateProgress();
                                const next = queue.shift();
                                if (next) next();
                            }).then(resolve);
                        });
                        if (active < maxConcurrent) {
                            const next = queue.shift();
                            if (next) next();
                        }
                    });
                }
            };
        }

        function updateProgress() {
            const total = allResults.length;
            const maxTotal = parseInt(document.getElementById('progressText').dataset.total);
            const percent = (total / maxTotal) * 100;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${total}/${maxTotal} (${percent.toFixed(0)}%)`;
        }

        async function testImage(host, port) {
            return new Promise((resolve) => {
                const start = performance.now();
                const target = `https://${host}:${port}/favicon.ico?${Date.now()}`;
                const img = new Image();
                
                img.onload = () => {
                    const end = performance.now();
                    const result = { host, port, time: end - start, success: true, target };
                    allResults.push(result);
                    if (result.time < FAST_THRESHOLD) {
                        addLiveHost(host, port, result.time);
                    }
                    resolve(result);
                };
                
                img.onerror = () => {
                    const end = performance.now();
                    const result = { host, port, time: end - start, success: false, target, error: 'Failed' };
                    allResults.push(result);
                    resolve(result);
                };
                
                img.src = target;
                
                setTimeout(() => {
                    if (!img.complete) {
                        const end = performance.now();
                        const result = { host, port, time: end - start, success: false, target, error: 'Timeout' };
                        allResults.push(result);
                        resolve(result);
                    }
                }, TIMEOUT);
            });
        }

        function addLiveHost(host, port, time) {
            const key = `${host}:${port}`;
            if (liveHosts.has(key)) return;
            
            liveHosts.add(key);
            const protocol = getProtocol(port);
            const url = `${protocol}://${host}:${port}/`;
            const liveHtml = `
                <div class="live-host">
                    <a href="${url}" target="_blank" class="live-link">${host}:${port}</a> 
                    <span style="color:#28a745; font-size:0.9em;">${time.toFixed(0)}ms</span>
                </div>`;
            
            document.getElementById('liveList').insertAdjacentHTML('beforeend', liveHtml);
            document.getElementById('liveCount').textContent = liveHosts.size;
        }

        function displayFinalResults(ipCount, portCount) {
            document.getElementById('progress').style.display = 'none';
            
            const fastHits = allResults.filter(r => r.success && r.time < FAST_THRESHOLD);
            const byIP = {};
            allResults.forEach(r => {
                if (!byIP[r.host]) byIP[r.host] = { fast: 0, total: 0 };
                byIP[r.host].total += ports.length;
                if (r.success && r.time < FAST_THRESHOLD) byIP[r.host].fast++;
            });
            
            const liveIPs = Object.entries(byIP)
                .filter(([_, stats]) => stats.fast > 0)
                .sort((a, b) => b[1].fast - a[1].fast);

            let html = `
                <div class="stats">
                    <div class="stat success">${fastHits.length} fast hits (<500ms)</div>
                    <div class="stat">${liveIPs.length}/${ipCount} IPs with fast services</div>
                    <div class="stat">${fastHits.length > 0 ? `${(fastHits.reduce((s, r) => s + r.time, 0) / fastHits.length).toFixed(0)}ms avg` : 'N/A'}</div>
                </div>`;

            document.getElementById('stats').innerHTML = html;
            document.getElementById('stats').style.display = 'flex';
        }
    </script>
</body>
</html>
